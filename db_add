#!/bin/bash

# Database Add Functions for BudgetBash

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Function to read a single keypress
read_key() {
  local key
  IFS= read -rsn1 key
  case "$key" in
  $'\x1b') # ESC sequence
    IFS= read -rsn2 key
    case "$key" in
    '[A') echo "UP" ;;
    '[B') echo "DOWN" ;;
    '[C') echo "RIGHT" ;;
    '[D') echo "LEFT" ;;
    *) echo "UNKNOWN" ;;
    esac
    ;;
  '') echo "ENTER" ;;
  'q'|'Q') echo "QUIT" ;;
  *) echo "UNKNOWN" ;;
  esac
}

# Function to check if backend is running
backend_running() {
  local port="${1:-$port_number}"
  if curl -s "localhost:${port}/" > /dev/null 2>&1; then
    return 0
  else
    return 1
  fi
}

# Function to submit data to backend
submit_data() {
  local data_type="$1"
  local year="$2"
  local date="$3"
  local type_field="$4"
  local coin_or_symbol="$5"
  local qty="$6"
  local category="$7"
  local subcategory="$8"
  local description="$9"
  local port="${10}"
  
  local url="localhost:${port}/add_data"
  local data="data_type=${data_type}&year=${year}&date=${date}&type=${type_field}&qty=${qty}&category=${category}&subcategory=${subcategory}&description=${description}"
  
  if [ "$data_type" = "cashflow" ]; then
    data="${data}&coin=${coin_or_symbol}"
  else
    data="${data}&symbol=${coin_or_symbol}"
  fi
  
  response=$(curl -s -X POST "${url}" -d "${data}")
  
  # Show success/error message with clear confirmation
  if echo "$response" | grep -q "Successfully"; then
    printf "\n  ${GREEN}✓ Data inserted successfully!${NC}\n"
    printf "  ${GREEN}  $response${NC}\n"
    return 0
  else
    printf "\n  ${RED}✗ Error inserting data${NC}\n"
    printf "  ${RED}  $response${NC}\n"
    return 1
  fi
}

# Interactive add data function
add_data() {
  local port="$1"
  
  if ! backend_running "$port"; then
    printf "  ${RED}Backend is not running on port ${port}. Please start it first.${NC}\n"
    return 1
  fi
  
  # Load config
  if [ ! -f "config.json" ]; then
    printf "  ${RED}Error: config.json not found${NC}\n"
    return 1
  fi
  
  # Data type selection
  local data_types=("cashflow" "investments")
  local current_data_type_index=0
  local data_type="${data_types[$current_data_type_index]}"
  
  # Function to load categories based on data_type
  load_categories() {
    categories=($(jq -r ".${data_type}.Category[]" config.json))
    if [ ${#categories[@]} -gt 0 ]; then
      category="${categories[0]}"
      current_category_index=0
    else
      category=""
      current_category_index=0
    fi
  }
  
  # Function to load coins (only for cashflow)
  load_coins() {
    if [ "$data_type" = "cashflow" ]; then
      coins=($(jq -r '.cashflow.Coin[]' config.json))
      if [ ${#coins[@]} -gt 0 ]; then
        coin="${coins[0]}"
        current_coin_index=0
      else
        coin=""
        current_coin_index=0
      fi
    else
      coins=()
      coin=""
      current_coin_index=0
    fi
  }
  
  # Load initial categories and coins
  load_categories
  load_coins
  
  # Year selection
  local current_year=$(date +%Y)
  local years=("2023" "2024" "2025" "2026")
  local current_year_index=3  # Default to 2026
  
  # Date input
  local date_input=""
  local date=$(date +%Y-%m-%d)
  
  # Type (bank/account) - common options
  local types=("Hype" "BBVA" "Revolut" "Directa" "ING" "INGCD" "Cash" "ETFs" "Cryptocurrencies")
  local current_type_index=0
  local type_field="${types[$current_type_index]}"
  
  # Coin or Symbol
  local current_coin_index=0
  local coin="${coins[$current_coin_index]}"
  local symbol_input=""
  
  # Quantity
  local qty=0.0
  local qty_input=""
  
  # Category
  local current_category_index=0
  local category="${categories[$current_category_index]}"
  local current_subcategory_index=0
  local subcategory=""
  
  # Description
  local description=""
  local description_input=""
  
  local current_field=1  # 1=data_type, 2=year, 3=date, 4=type, 5=coin/symbol, 6=qty, 7=category, 8=subcategory, 9=description, 10=insert
  
  # Function to load subcategories for current category
  load_subcategories() {
    subcategories=($(curl -s "localhost:${port}/get_subcategories?category=$category&data_type=${data_type}" | tr ',' ' '))
    if [ ${#subcategories[@]} -gt 0 ] && [ -n "${subcategories[0]}" ]; then
      subcategory="${subcategories[0]}"
      current_subcategory_index=0
    else
      subcategory=""
      current_subcategory_index=0
    fi
  }
  
  # Load initial subcategories
  load_subcategories
  
  while true; do
    clear
    printf "  ${YELLOW}Add New Data to Database${NC}\n"
    printf "  ${CYAN}========================${NC}\n\n"
    
    # Display form
    if [ $current_field -eq 1 ]; then
      printf "  ${BOLD}${CYAN}▶ Data Type: ${data_type}${NC}\n"
    else
      printf "  ${GREEN}  Data Type: ${data_type}${NC}\n"
    fi
    
    if [ $current_field -eq 2 ]; then
      printf "  ${BOLD}${CYAN}▶ Year: ${years[$current_year_index]}${NC}\n"
    else
      printf "  ${GREEN}  Year: ${years[$current_year_index]}${NC}\n"
    fi
    
    if [ $current_field -eq 3 ]; then
      printf "  ${BOLD}${CYAN}▶ Date: ${date}${NC}\n"
    else
      printf "  ${GREEN}  Date: ${date}${NC}\n"
    fi
    
    if [ $current_field -eq 4 ]; then
      printf "  ${BOLD}${CYAN}▶ Type: ${type_field}${NC}\n"
    else
      printf "  ${GREEN}  Type: ${type_field}${NC}\n"
    fi
    
    if [ $current_field -eq 5 ]; then
      if [ "$data_type" = "cashflow" ]; then
        printf "  ${BOLD}${CYAN}▶ Coin: ${coin}${NC}\n"
      else
        printf "  ${BOLD}${CYAN}▶ Symbol: ${symbol_input}${NC}\n"
      fi
    else
      if [ "$data_type" = "cashflow" ]; then
        printf "  ${GREEN}  Coin: ${coin}${NC}\n"
      else
        printf "  ${GREEN}  Symbol: ${symbol_input}${NC}\n"
      fi
    fi
    
    if [ $current_field -eq 6 ]; then
      printf "  ${BOLD}${CYAN}▶ Quantity: ${qty_input}${NC}\n"
    else
      printf "  ${GREEN}  Quantity: ${qty_input}${NC}\n"
    fi
    
    if [ $current_field -eq 7 ]; then
      printf "  ${BOLD}${CYAN}▶ Category: ${category}${NC}\n"
    else
      printf "  ${GREEN}  Category: ${category}${NC}\n"
    fi
    
    if [ $current_field -eq 8 ]; then
      if [ -n "$subcategory" ]; then
        printf "  ${BOLD}${CYAN}▶ Subcategory: ${subcategory}${NC}\n"
      else
        printf "  ${BOLD}${CYAN}▶ Subcategory: (none)${NC}\n"
      fi
    else
      if [ -n "$subcategory" ]; then
        printf "  ${GREEN}  Subcategory: ${subcategory}${NC}\n"
      else
        printf "  ${GREEN}  Subcategory: (none)${NC}\n"
      fi
    fi
    
    if [ $current_field -eq 9 ]; then
      printf "  ${BOLD}${CYAN}▶ Description: ${description_input}${NC}\n"
    else
      printf "  ${GREEN}  Description: ${description_input}${NC}\n"
    fi
    
    if [ $current_field -eq 10 ]; then
      printf "  ${BOLD}${CYAN}▶ Insert${NC}\n"
    else
      printf "  ${GREEN}  Insert${NC}\n"
    fi
    
    printf "\n  ${YELLOW}Use ↑↓ to navigate, ←→ to change values, Enter to select${NC}\n"
    printf "  ${YELLOW}Press 'q' to go back to menu${NC}\n"
    
    key=$(read_key)
    
    # Debug: uncomment to see what key is being received
    # printf "\nDEBUG: key='$key'\n" >&2
    
    case "$key" in
      "UP")
        if [ $current_field -gt 1 ]; then
          ((current_field--))
        else
          current_field=10
        fi
        ;;
      "DOWN")
        if [ $current_field -lt 10 ]; then
          ((current_field++))
        else
          current_field=1
        fi
        ;;
      "LEFT")
        case $current_field in
          1) # Data type
            if [ $current_data_type_index -gt 0 ]; then
              ((current_data_type_index--))
              data_type="${data_types[$current_data_type_index]}"
              load_categories
              load_coins
              load_subcategories
            fi
            ;;
          2) # Year
            if [ $current_year_index -gt 0 ]; then
              ((current_year_index--))
            fi
            ;;
          3) # Date - decrement day
            date=$(date -d "$date -1 day" +%Y-%m-%d 2>/dev/null || date -v-1d -j -f "%Y-%m-%d" "$date" +%Y-%m-%d 2>/dev/null || echo "$date")
            ;;
          4) # Type
            if [ $current_type_index -gt 0 ]; then
              ((current_type_index--))
              type_field="${types[$current_type_index]}"
            fi
            ;;
          5) # Coin/Symbol
            if [ "$data_type" = "cashflow" ]; then
              if [ $current_coin_index -gt 0 ]; then
                ((current_coin_index--))
                coin="${coins[$current_coin_index]}"
              fi
            fi
            ;;
          7) # Category
            if [ $current_category_index -gt 0 ]; then
              ((current_category_index--))
              category="${categories[$current_category_index]}"
              load_subcategories
            fi
            ;;
          8) # Subcategory
            if [ ${#subcategories[@]} -gt 0 ] && [ $current_subcategory_index -gt 0 ]; then
              ((current_subcategory_index--))
              subcategory="${subcategories[$current_subcategory_index]}"
            fi
            ;;
        esac
        ;;
      "RIGHT")
        case $current_field in
          1) # Data type
            if [ $current_data_type_index -lt $((${#data_types[@]} - 1)) ]; then
              ((current_data_type_index++))
              data_type="${data_types[$current_data_type_index]}"
              load_categories
              load_coins
              load_subcategories
            fi
            ;;
          2) # Year
            if [ $current_year_index -lt $((${#years[@]} - 1)) ]; then
              ((current_year_index++))
            fi
            ;;
          3) # Date - increment day
            date=$(date -d "$date +1 day" +%Y-%m-%d 2>/dev/null || date -v+1d -j -f "%Y-%m-%d" "$date" +%Y-%m-%d 2>/dev/null || echo "$date")
            ;;
          4) # Type
            if [ $current_type_index -lt $((${#types[@]} - 1)) ]; then
              ((current_type_index++))
              type_field="${types[$current_type_index]}"
            fi
            ;;
          5) # Coin/Symbol
            if [ "$data_type" = "cashflow" ]; then
              if [ $current_coin_index -lt $((${#coins[@]} - 1)) ]; then
                ((current_coin_index++))
                coin="${coins[$current_coin_index]}"
              fi
            fi
            ;;
          7) # Category
            if [ $current_category_index -lt $((${#categories[@]} - 1)) ]; then
              ((current_category_index++))
              category="${categories[$current_category_index]}"
              load_subcategories
            fi
            ;;
          8) # Subcategory
            if [ ${#subcategories[@]} -gt 0 ] && [ $current_subcategory_index -lt $((${#subcategories[@]} - 1)) ]; then
              ((current_subcategory_index++))
              subcategory="${subcategories[$current_subcategory_index]}"
            fi
            ;;
        esac
        ;;
      "ENTER")
        case $current_field in
          5) # Symbol input (for investments)
            if [ "$data_type" = "investments" ]; then
              printf "  Enter symbol: "
              read -r symbol_input
            fi
            ;;
          6) # Quantity input
            printf "  Enter quantity: "
            read -r qty_input
            if [[ "$qty_input" =~ ^-?[0-9]+\.?[0-9]*$ ]]; then
              qty="$qty_input"
            else
              printf "  ${RED}Invalid quantity.${NC}\n"
              sleep 1
            fi
            ;;
          9) # Description input
            printf "  Enter description: "
            read -r description_input
            description="$description_input"
            ;;
          10) # Insert data
            # Check if all required fields are set
            if [ -z "$qty_input" ] || [ "$qty" = "0.0" ]; then
              printf "  ${RED}Please enter a quantity first!${NC}\n"
              sleep 2
            elif [ "$data_type" = "investments" ] && [ -z "$symbol_input" ]; then
              printf "  ${RED}Please enter a symbol first!${NC}\n"
              sleep 2
            else
              local coin_or_symbol
              if [ "$data_type" = "cashflow" ]; then
                coin_or_symbol="$coin"
              else
                coin_or_symbol="$symbol_input"
              fi
              if submit_data "$data_type" "${years[$current_year_index]}" "$date" "$type_field" "$coin_or_symbol" "$qty" "$category" "$subcategory" "$description" "$port"; then
                # Clear the quantity and description inputs after successful insert for next entry
                # But keep other fields (date, type, category, etc.) for bulk entry
                qty_input=""
                qty=0.0
                description_input=""
                description=""
                printf "  ${YELLOW}Press any key to continue...${NC}\n"
                read -n 1
              else
                printf "  ${YELLOW}Press any key to continue...${NC}\n"
                read -n 1
              fi
              # Don't return - stay on the same page with same values for bulk data entry
            fi
            ;;
        esac
        ;;
      "QUIT")
        return
        ;;
    esac
  done
}

