#!/bin/bash

# Database Delete Functions for BudgetBash

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Function to read a single keypress
read_key() {
  local key
  IFS= read -rsn1 key
  case $key in
  $'\x1b') # ESC sequence
    IFS= read -rsn2 key
    case $key in
    '[A') echo "UP" ;;
    '[B') echo "DOWN" ;;
    '[C') echo "RIGHT" ;;
    '[D') echo "LEFT" ;;
    *) echo "UNKNOWN" ;;
    esac
    ;;
  '') echo "ENTER" ;;
  'q'|'Q') echo "QUIT" ;;
  *) echo "UNKNOWN" ;;
  esac
}

# Function to check if backend is running
backend_running() {
  local port="${1:-$port_number}"
  if curl -s "localhost:${port}/" > /dev/null 2>&1; then
    return 0
  else
    return 1
  fi
}

# Function to show backend error
show_backend_error() {
  clear
  printf "  ${RED}Backend is not running, please start it first...${NC}\n"
  printf "  ${YELLOW}Press any key to continue...${NC}\n"
  read -n 1
}

# Function to load database data
load_database_data() {
  local data_type="$1"
  local year="$2"
  local month="$3"
  local port="$4"
  
  if ! backend_running "$port"; then
    show_backend_error
    return 1
  fi
  
  # Get database data from backend
  response=$(curl -s "localhost:${port}/view_database?data_type=${data_type}&year=${year}&month=${month}")
  
  if [ $? -eq 0 ]; then
    # Split the response into lines and store globally
    IFS=$'\n' read -rd '' -a table_lines <<< "$response"
    return 0
  else
    printf "  ${RED}Error: Could not fetch database${NC}\n"
    return 1
  fi
}

# Function to redraw table with current selection
redraw_table_with_selection() {
  # Clear screen and redraw everything
  clear
  printf "  ${YELLOW}Database - Select Row to Delete${NC}\n"
  printf "  ${CYAN}===============================${NC}\n\n"
  
  # Display each line with selection indicator
  local data_row_index=0
  for i in "${!table_lines[@]}"; do
    # Only show indicator on data rows (skip header and separator lines)
    if [[ "${table_lines[$i]}" =~ ^\|[[:space:]]*[0-9]+ ]]; then
      # This is a data row
      if [ $current_selection -eq $data_row_index ]; then
        printf "  ${BOLD}${CYAN}-->${NC} ${table_lines[$i]}\n"
      else
        printf "     ${table_lines[$i]}\n"
      fi
      ((data_row_index++))
    else
      # This is a header or separator line
      printf "     ${table_lines[$i]}\n"
    fi
  done
  printf "\n"
}

# Function to get row data for confirmation
get_row_data() {
  local line_number="$1"
  local data_type="$2"
  local year="$3"
  local month="$4"
  local port="$5"
  response=$(curl -s "localhost:${port}/get_row_data?line_number=$line_number&data_type=${data_type}&year=${year}&month=${month}")
  echo "$response"
}

# Function to confirm deletion
confirm_deletion() {
  local line_number="$1"
  local row_data="$2"
  
  printf "\n  ${RED}Are you sure you want to delete this row?${NC}\n"
  echo -e "  ${CYAN}Row $line_number: $row_data${NC}"
  printf "  ${YELLOW}Type 'yes' to confirm or anything else to cancel: ${NC}"
  read -r confirmation
  
  if [ "$confirmation" = "yes" ]; then
    return 0
  else
    return 1
  fi
}

# Function to delete row via backend
delete_row() {
  local line_number="$1"
  local data_type="$2"
  local year="$3"
  local month="$4"
  local port="$5"
  
  response=$(curl -s -X POST "localhost:${port}/delete_row" \
    -d "line_number=$line_number&data_type=${data_type}&year=${year}&month=${month}")
  
  if [ $? -eq 0 ]; then
    printf "  ${GREEN}✓ %s${NC}\n" "$response"
  else
    printf "  ${RED}✗ Error deleting row${NC}\n"
  fi
}

# Main delete function with navigation
delete_data() {
  local port="$1"
  
  if ! backend_running "$port"; then
    show_backend_error
    return
  fi
  
  # Data type selection
  local data_types=("cashflow" "investments")
  local current_data_type_index=0
  local data_type="${data_types[$current_data_type_index]}"
  
  # Year selection
  local years=("2023" "2024" "2025" "2026")
  local current_year_index=2  # Default to 2025
  local year="${years[$current_year_index]}"
  
  # Month selection
  local months=("1" "2" "3" "4" "5" "6" "7" "8" "9" "10" "11" "12")
  local month_names=("January" "February" "March" "April" "May" "June" "July" "August" "September" "October" "November" "December")
  local current_month_index=0
  local month="${months[$current_month_index]}"
  
  local current_selection_field=1  # 1=data_type, 2=year, 3=month
  
  # First, select data type, year, and month
  while true; do
    clear
    printf "  ${YELLOW}Delete Data - Select Parameters${NC}\n"
    printf "  ${CYAN}=================================${NC}\n\n"
    
    if [ $current_selection_field -eq 1 ]; then
      printf "  ${BOLD}${CYAN}▶ Data Type: ${data_type}${NC}\n"
    else
      printf "  ${GREEN}  Data Type: ${data_type}${NC}\n"
    fi
    
    if [ $current_selection_field -eq 2 ]; then
      printf "  ${BOLD}${CYAN}▶ Year: ${year}${NC}\n"
    else
      printf "  ${GREEN}  Year: ${year}${NC}\n"
    fi
    
    if [ $current_selection_field -eq 3 ]; then
      printf "  ${BOLD}${CYAN}▶ Month: ${month_names[$current_month_index]} (${month})${NC}\n"
    else
      printf "  ${GREEN}  Month: ${month_names[$current_month_index]} (${month})${NC}\n"
    fi
    
    printf "\n  ${YELLOW}Use ↑↓ to navigate, ←→ to change values, Enter to confirm${NC}\n"
    printf "  ${YELLOW}Press 'q' to cancel${NC}\n"
    
    key=$(read_key)
    
    case $key in
      "UP")
        if [ $current_selection_field -gt 1 ]; then
          ((current_selection_field--))
        else
          current_selection_field=3
        fi
        ;;
      "DOWN")
        if [ $current_selection_field -lt 3 ]; then
          ((current_selection_field++))
        else
          current_selection_field=1
        fi
        ;;
      "LEFT")
        case $current_selection_field in
          1) # Data type
            if [ $current_data_type_index -gt 0 ]; then
              ((current_data_type_index--))
              data_type="${data_types[$current_data_type_index]}"
            fi
            ;;
          2) # Year
            if [ $current_year_index -gt 0 ]; then
              ((current_year_index--))
              year="${years[$current_year_index]}"
            fi
            ;;
          3) # Month
            if [ $current_month_index -gt 0 ]; then
              ((current_month_index--))
              month="${months[$current_month_index]}"
            fi
            ;;
        esac
        ;;
      "RIGHT")
        case $current_selection_field in
          1) # Data type
            if [ $current_data_type_index -lt $((${#data_types[@]} - 1)) ]; then
              ((current_data_type_index++))
              data_type="${data_types[$current_data_type_index]}"
            fi
            ;;
          2) # Year
            if [ $current_year_index -lt $((${#years[@]} - 1)) ]; then
              ((current_year_index++))
              year="${years[$current_year_index]}"
            fi
            ;;
          3) # Month
            if [ $current_month_index -lt $((${#months[@]} - 1)) ]; then
              ((current_month_index++))
              month="${months[$current_month_index]}"
            fi
            ;;
        esac
        ;;
      "ENTER")
        # Load database and proceed to row selection
        break
        ;;
      "QUIT")
        return
        ;;
    esac
  done
  
  # Get total number of rows
  max_lines=$(curl -s "localhost:${port}/get_row_count?data_type=${data_type}&year=${year}&month=${month}")
  
  if [ -z "$max_lines" ] || [ "$max_lines" -eq 0 ] || [ "$max_lines" = "Error" ]; then
    clear
    printf "  ${RED}No data to delete${NC}\n"
    printf "  ${YELLOW}Press any key to continue...${NC}\n"
    read -n 1
    return
  fi
  
  # Load database data
  if ! load_database_data "$data_type" "$year" "$month" "$port"; then
    return
  fi
  
  local current_selection=$((max_lines - 1))  # Start at last row
  local max_index=$((max_lines - 1))
  
  while true; do
    # Redraw table with current selection
    redraw_table_with_selection
    
    # Show current selection info
    printf "  ${YELLOW}Current selection: Row ${current_selection}${NC}\n"
    printf "  ${CYAN}Use ↑ ↓ to navigate, Enter to select, 'q' to cancel${NC}\n"
    
    key=$(read_key)
    
    case $key in
      "UP")
        if [ $current_selection -gt 0 ]; then
          ((current_selection--))
        fi
        ;;
      "DOWN")
        if [ $current_selection -lt $max_index ]; then
          ((current_selection++))
        fi
        ;;
      "ENTER")
        # Get row data for confirmation
        row_data=$(get_row_data "$current_selection" "$data_type" "$year" "$month" "$port")
        
        # Confirm deletion
        if confirm_deletion "$current_selection" "$row_data"; then
          # Delete the row
          delete_row "$current_selection" "$data_type" "$year" "$month" "$port"
          
          # Update max index after deletion
          max_lines=$(curl -s "localhost:${port}/get_row_count?data_type=${data_type}&year=${year}&month=${month}")
          max_index=$((max_lines - 1))
          
          # Adjust current selection if needed
          if [ $current_selection -gt $max_index ] && [ $max_index -ge 0 ]; then
            current_selection=$max_index
          fi
          
          # Check if no more data
          if [ "$max_lines" = "0" ] || [ -z "$max_lines" ]; then
            printf "  ${BLUE}No more data to delete${NC}\n"
            printf "  ${YELLOW}Press any key to continue...${NC}\n"
            read -n 1
            return
          fi
          
          # Reload database data
          load_database_data "$data_type" "$year" "$month" "$port"
          
          printf "  ${YELLOW}Press any key to continue...${NC}\n"
          read -n 1
        else
          printf "  ${BLUE}Deletion cancelled${NC}\n"
          sleep 1
        fi
        ;;
      "QUIT")
        return
        ;;
    esac
  done
}

